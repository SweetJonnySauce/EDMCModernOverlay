name: VirusTotal Scan
on:
  workflow_call:
    inputs:
      artifact:
        required: true
        type: string
      pattern:
        required: true
        type: string
      ref:
        required: false
        type: string
      release_id:
        required: false
        type: string
      publish_release_notes:
        required: false
        type: boolean
        default: false
      release_tag:
        required: false
        type: string
      artifact_suffix:
        required: false
        type: string
        default: ""
      force_upload:
        required: false
        type: boolean
        default: false
    outputs:
      scan_status:
        description: "Status of the VT scan (success/flagged/error)"
        value: ${{ jobs.scan.outputs.scan_status }}
    secrets:
      VT_API_KEY:
        required: true
permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    outputs:
      scan_status: ${{ steps.scan_status.outputs.scan_status }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact }}
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install VirusTotal client deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Scan with VirusTotal
        id: vt_scan
        continue-on-error: true
        env:
          VT_API_KEY: ${{ secrets.VT_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
          RELEASE_ID: ${{ inputs.release_id }}
          RELEASE_TAG: ${{ inputs.release_tag }}
          PUBLISH_RELEASE_NOTES: ${{ inputs.publish_release_notes }}
          ARTIFACT_NAME: ${{ inputs.artifact }}
          ARTIFACT_SUFFIX: ${{ inputs.artifact_suffix }}
          FORCE_UPLOAD: ${{ inputs.force_upload }}
          VT_BADGE_PATH: vt_badges.md
          VT_STATUS_PATH: vt_status.txt
        run: |
          set -euo pipefail
          python - <<'PY'
          import glob
          import os
          import sys
          import time
          import hashlib
          import urllib.parse
          import requests
          from pathlib import Path

          repo = os.environ.get("GITHUB_REPOSITORY")
          release_id = os.environ.get("RELEASE_ID")
          gh_token = os.environ.get("GITHUB_TOKEN")
          publish_notes = (os.environ.get("PUBLISH_RELEASE_NOTES") or "").lower() in ("1", "true", "yes", "on")
          release_tag = os.environ.get("RELEASE_TAG") or ""
          badge_path = os.environ.get("VT_BADGE_PATH") or "vt_badges.md"
          status_path = Path(os.environ.get("VT_STATUS_PATH") or "vt_status.txt")
          artifact_name = os.environ.get("ARTIFACT_NAME") or ""
          artifact_suffix = os.environ.get("ARTIFACT_SUFFIX") or ""
          force_upload = (os.environ.get("FORCE_UPLOAD") or "").lower() in ("1", "true", "yes", "on")

          api_key = os.environ.get("VT_API_KEY") or os.environ.get("VIRUSTOTAL_API_KEY")
          session = requests.Session()
          session.headers["x-apikey"] = api_key

          pattern = "${{ inputs.pattern }}"
          targets = [p for p in glob.glob(pattern, recursive=True) if os.path.isfile(p)]
          if not targets:
              print(f"No files matched pattern: {pattern}", file=sys.stderr)

          def sha256sum(path: str) -> str:
              h = hashlib.sha256()
              with open(path, "rb") as handle:
                  for chunk in iter(lambda: handle.read(8192), b""):
                      h.update(chunk)
              return h.hexdigest()

          def scan_one(target: str):
              sha = sha256sum(target)
              vt_url = f"https://www.virustotal.com/gui/file/{sha}"
              print(f"Scanning {target} ({sha})", flush=True)
              print(f"VT report URL: {vt_url}", flush=True)

              if not force_upload:
                  resp = session.get(f"https://www.virustotal.com/api/v3/files/{sha}", timeout=30)
                  if resp.status_code == 200:
                      data = resp.json().get("data", {})
                      stats = data.get("attributes", {}).get("last_analysis_stats")
                      if stats:
                          print(f"Existing VT stats: {stats}", flush=True)
                          print(f"VT report URL: {vt_url}", flush=True)
                          clean = not (stats.get("malicious", 0) or stats.get("suspicious", 0))
                          return clean, sha, vt_url, stats

              with open(target, "rb") as handle:
                  upload = session.post(
                      "https://www.virustotal.com/api/v3/files",
                      files={"file": (os.path.basename(target), handle)},
                      timeout=120,
                  )
              upload.raise_for_status()
              analysis_id = upload.json()["data"]["id"]
              print(f"Uploaded; analysis id {analysis_id}", flush=True)

              while True:
                  r = session.get(f"https://www.virustotal.com/api/v3/analyses/{analysis_id}", timeout=30)
                  r.raise_for_status()
                  data = r.json()["data"]
                  status = data["attributes"]["status"]
                  if status == "completed":
                      stats = data["attributes"]["stats"]
                      print(f"VT stats: {stats}", flush=True)
                      print(f"VT report URL: {vt_url}", flush=True)
                      clean = not (stats.get("malicious", 0) or stats.get("suspicious", 0))
                      return clean, sha, vt_url, stats
                  print(f"VT status: {status}, waiting...", flush=True)
                  time.sleep(30)

          def persist_status(value: str) -> None:
              try:
                  status_path.write_text(value, encoding="utf-8")
              except Exception as err:
                  print(f"Failed to write scan status to {status_path}: {err}", file=sys.stderr)

          def run_scan() -> tuple[str, int]:
              if not api_key:
                  print("VT_API_KEY not set; expected VT_API_KEY or VIRUSTOTAL_API_KEY.", flush=True)
                  return "error", 1
              if not targets:
                  print(f"No files matched pattern: {pattern}", file=sys.stderr)
                  return "error", 1

              all_clean = True
              results = []
              for target in targets:
                  clean, sha, vt_url, stats = scan_one(target)
                  results.append({"file": target, "sha": sha, "url": vt_url, "stats": stats, "clean": clean})
                  if not clean:
                      all_clean = False
                      print(f"VirusTotal flagged: {target}", flush=True)

              def append_release_notes(summary: str) -> None:
                  if not publish_notes:
                      return
                  if not (release_id and repo and gh_token):
                      return
                  api = f"https://api.github.com/repos/{repo}/releases/{release_id}"
                  headers = {
                      "Authorization": f"Bearer {gh_token}",
                      "Accept": "application/vnd.github+json",
                  }
                  current = session.get(api, headers=headers, timeout=30)
                  current.raise_for_status()
                  body = current.json().get("body") or ""
                  new_body = body + "\n\n" + summary if body else summary
                  resp = session.patch(api, headers=headers, json={"body": new_body}, timeout=30)
                  resp.raise_for_status()

              lines = ["VirusTotal scan results:"]
              for r in results:
                  status_word = "clean" if r["clean"] else "flagged"
                  lines.append(f"- {r['file']} ({r['sha']}): {status_word} {r['stats']} - {r['url']}")
              summary = "\n".join(lines)
              print(summary, flush=True)

              # Build badges per scanned file for release notes
              badges = []
              for r in results:
                  badge_message = "clean" if r["clean"] else "flagged"
                  badge_color = "brightgreen" if r["clean"] else "red"
                  asset_name = os.path.basename(r["file"])
                  label = asset_name
                  # Shields: use dash form with explicit escaping of "-" -> "--" and "_" -> "__", then URL-encode.
                  def shields_field(value: str) -> str:
                      return urllib.parse.quote(value.replace("-", "--").replace("_", "__"))
                  badge_url = "https://img.shields.io/badge/{label}-{msg}-{color}.svg".format(
                      label=shields_field(label),
                      msg=shields_field(badge_message),
                      color=badge_color,
                  )
                  primary_url = r["url"] or "https://www.virustotal.com/"
                  badges.append(f"[![{label}]({badge_url})]({primary_url})")
              if badges:
                  append_release_notes("\n".join(badges))

              # Persist badges for aggregation
              with open(badge_path, "w", encoding="utf-8") as fh:
                  for line in badges:
                      fh.write(f"{line}\n\n")

              status_value = "success" if all_clean else "flagged"
              exit_code = 0 if all_clean else 2
              if not all_clean:
                  print("VirusTotal flagged one or more files; continuing to allow aggregation.", flush=True)
              return status_value, exit_code

          scan_status = "error"
          exit_code = 1
          try:
              scan_status, exit_code = run_scan()
          except Exception as exc:
              scan_status = "error"
              exit_code = 1
              print(f"VirusTotal scan failed: {exc}", file=sys.stderr)
          finally:
              persist_status(scan_status)

          def ensure_badges_file(status_value: str) -> None:
              path = Path(badge_path)
              if path.exists() and path.stat().st_size > 0:
                  return
              message = status_value or "error"
              color = "brightgreen" if message == "success" else "red"

              def shields_field(value: str) -> str:
                  return urllib.parse.quote(value.replace("-", "--").replace("_", "__"))

              lines = []
              if targets:
                  for target in targets:
                      asset_name = os.path.basename(target)
                      label = asset_name
                      badge_url = "https://img.shields.io/badge/{label}-{msg}-{color}.svg".format(
                          label=shields_field(label),
                          msg=shields_field(message),
                          color=color,
                      )
                      lines.append(f"[![{label}]({badge_url})](https://www.virustotal.com/)")
                      lines.append("")
              else:
                  # Build a friendlier label when no targets were scanned.
                  pattern_label = os.path.basename(pattern) or pattern or "scan"
                  if "*" in pattern_label and release_tag:
                      pattern_label = pattern_label.replace("*", release_tag)
                  clean_label = pattern_label.replace("*", "").strip("-") or "scan"
                  label = clean_label or "scan"
                  badge_url = "https://img.shields.io/badge/{label}-{msg}-{color}.svg".format(
                      label=shields_field(label),
                      msg=shields_field(message),
                      color=color,
                  )
                  lines.append(f"[![{label}]({badge_url})](https://www.virustotal.com/)")
                  lines.append("")
              path.write_text("\n".join(lines) + "\n", encoding="utf-8")

          ensure_badges_file(scan_status)
          sys.exit(exit_code)
          PY

      - name: Capture scan status
        id: scan_status
        if: always()
        env:
          VT_STATUS_PATH: vt_status.txt
        run: |
          set -euo pipefail
          status_path="${VT_STATUS_PATH:-vt_status.txt}"
          status="error"
          if [[ -f "$status_path" ]]; then
              status="$(tr -d '\r\n' < "$status_path" || true)"
          fi
          if [[ -z "$status" ]]; then
              status="error"
          fi
          echo "scan_status=${status}" >> "$GITHUB_OUTPUT"

      - name: Upload VT badges fragment
        uses: actions/upload-artifact@v4
        with:
          name: vt-report-${{ inputs.release_tag || inputs.release_id || github.run_id }}${{ inputs.artifact_suffix != '' && format('-{0}', inputs.artifact_suffix) || '' }}
          path: vt_badges.md
          overwrite: true
